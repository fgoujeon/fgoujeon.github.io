<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maki: State Machine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Maki
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('state-machine.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">State Machine </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2home_2florian_2Development_2maki_2src_2doc_2concepts_2state-machine"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md26"></a>
Definition</h1>
<p>A state machine (also known as finite-state machine, FSM, or SM) is a model that defines all the possible states of a system, the events that trigger a transition from one state to another, and the actions that are performed when these transitions occur.</p>
<p>A very simple example of such a system is a lamp. It has:</p>
<ul>
<li>2 states: off and on;</li>
<li>1 event: a button press;</li>
<li>2 actions: turn light on and turn light off.</li>
</ul>
<p>State machines are often represented by diagrams. Here is the state machine of our lamp, under the form of a UML state diagram:</p>
<div class="plantumlgraph">
<img src="lamp.png" />
<div class="caption">
The state machine of a lamp</div>
</div>
<p>The diagram shows that:</p>
<ul>
<li>the initial state (i.e. the active state when the machine starts) is <span class="tt">off</span> (as pointed to by the black dot);</li>
<li>pressing the button while the <span class="tt">off</span> state is active executes the <span class="tt">turn light on</span> action and activates the <span class="tt">on</span> state;</li>
<li>pressing the button while the <span class="tt">on</span> state is active executes the <span class="tt">turn light off</span> action and activates the <span class="tt">off</span> state.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md27"></a>
When to use a state machine</h1>
<p>When suitable, state machines help you:</p>
<ul>
<li>improve the readability (and thus maintainability) of your code;</li>
<li>organize your code (by putting each state in its own file, for example);</li>
<li>visualize what your code is doing at a high level (particularly if it is backed by a state diagram and/or a transition table);</li>
<li>log meaningful messages to keep track of the state of your program.</li>
</ul>
<p>State machines are particularly well suited to implement the event-processing part of an event-driven architecture.</p>
<p>If your code defines many event-handling functions like the following one, it would most likely benefit from the introduction of a state machine:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> on_button_press()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>(is_power_on)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(motor_is_running)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">//...</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(5 &lt; temperature_degc &amp;&amp; temperature_degc &lt; 50)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">//...</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//...</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md28"></a>
What Maki can do for you</h1>
<p>Admittedly, you don't <em>need</em> a library to implement a state machine. A couple of <span class="tt">enum</span>s and <span class="tt">switch</span>es can do the trick for simple cases. However, when things get complicated or when you need more advanced features, some sort of state machine framework becomes very handy, if not mandatory.</p>
<p>One of the most important things a library such as Maki provides is a <b>transition table</b>.</p>
<p>When you set up a state machine with Maki, you have to write a transition table. A transition table is a direct representation of a state diagram in your code. Here is the transition table of our lamp, written with Maki:</p>
<div class="fragment"><div class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> transition_table = <a class="code hl_class" href="classmaki_1_1transition__table.html">maki::transition_table</a>{}</div>
<div class="line">    <span class="comment">//source,   target, event,                     action</span></div>
<div class="line">    (maki::ini, off) <span class="comment">//Initial state is `off`.</span></div>
<div class="line">    (off,       on,     maki::event&lt;button_press&gt;, turn_light_on)</div>
<div class="line">    (on,        off,    maki::event&lt;button_press&gt;, turn_light_off)</div>
<div class="line">;</div>
</div><!-- fragment --><p>This is hopefully self-explanatory, but here is how it is structured:</p>
<ul>
<li>each row of the table represents a possible state transition;</li>
<li>when <span class="tt">source state</span> is the active state and <span class="tt">event</span> occurs, the state machine executes <span class="tt">action</span> and activates <span class="tt">target state</span>.</li>
</ul>
<p>This gives you a nice overview of what a program does. Moreover, the more complex a state machine is, the more valuable a transition table is for the readability of your code.</p>
<p><b>[TIP]</b> Transition tables are much more readable when their "columns" are properly aligned. If an alignment plugin exists for your code editor, it's time to install it!</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md29"></a>
Example program</h2>
<p>Here is a test program that uses the transition table we defined above:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;maki.hpp&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">An object of this type is created by the state machine and made accessible to</span></div>
<div class="line"><span class="comment">all the components (actions, guards, states) of the state machine.</span></div>
<div class="line"><span class="comment">More about that later.</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"><span class="keyword">struct </span>context{};</div>
<div class="line"> </div>
<div class="line"><span class="comment">//Events are types (more about that later)</span></div>
<div class="line"><span class="keyword">struct </span>button_press{};</div>
<div class="line"> </div>
<div class="line"><span class="comment">//States are made from constexpr objects (more about that later)</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> off = <a class="code hl_class" href="classmaki_1_1state__mold.html">maki::state_mold</a>{};</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> on = <a class="code hl_class" href="classmaki_1_1state__mold.html">maki::state_mold</a>{};</div>
<div class="line"> </div>
<div class="line"><span class="comment">//Actions are constexpr objects (more about that later)</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> turn_light_on = <a class="code hl_function" href="structmaki_1_1action.html#aa711c649363b4ee331736189f1a87593">maki::action_v</a>([]</div>
<div class="line">{</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Light is on\n&quot;</span>;</div>
<div class="line">});</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> turn_light_off = <a class="code hl_function" href="structmaki_1_1action.html#aa711c649363b4ee331736189f1a87593">maki::action_v</a>([]</div>
<div class="line">{</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Light is off\n&quot;</span>;</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line"><span class="comment">//The transition table</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> transition_table = <a class="code hl_class" href="classmaki_1_1transition__table.html">maki::transition_table</a>{}</div>
<div class="line">    <span class="comment">//source,   target, event,                     action</span></div>
<div class="line">    (maki::ini, off) <span class="comment">//Initial state is `off`.</span></div>
<div class="line">    (off,       on,     maki::event&lt;button_press&gt;, turn_light_on)</div>
<div class="line">    (on,        off,    maki::event&lt;button_press&gt;, turn_light_off)</div>
<div class="line">;</div>
<div class="line"> </div>
<div class="line"><span class="comment">//The configuration of the state machine</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keyword">auto</span> machine_conf = <a class="code hl_class" href="classmaki_1_1machine__conf.html">maki::machine_conf</a>{}</div>
<div class="line">    .<a class="code hl_function" href="classmaki_1_1machine__conf.html#a1109f760a91762e78f2ec1143f46301e">transition_tables</a>(transition_table)</div>
<div class="line">    .context_a&lt;context&gt;()</div>
<div class="line">;</div>
<div class="line"> </div>
<div class="line"><span class="comment">//The state machine</span></div>
<div class="line"><span class="keyword">using </span>machine_t = <a class="code hl_class" href="classmaki_1_1machine.html">maki::machine&lt;machine_conf&gt;</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//Instantiation of the state machine.</span></div>
<div class="line">    <span class="comment">//Initial state is `off`.</span></div>
<div class="line">    <span class="keyword">auto</span> machine = machine_t{};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Process a button press event. This will call turn_light_on() and activate</span></div>
<div class="line">    <span class="comment">//the `on` state.</span></div>
<div class="line">    machine.<a class="code hl_function" href="classmaki_1_1machine.html#a1a302486e82bc0ecc021ae1ccb38f44c">process_event</a>(button_press{});</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Process a button press event again. This will call turn_light_off() and</span></div>
<div class="line">    <span class="comment">//activate the `off` state.</span></div>
<div class="line">    machine.process_event(button_press{});</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The output of this program is the following:</p>
<div class="fragment"><div class="line">Light is on</div>
<div class="line">Light is off</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="index.html">Maki</a></li><li class="navelem"><a href="concepts.html">Concepts</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
